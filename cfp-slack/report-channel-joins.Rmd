---
title: "Who Joined Code for Philly Slack Channels in the Last 10 Days?"
output:
  html_document:
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(lubridate)

# install.packages("slackr")
library(slackr)

# note that I had to 
source("fix-slackr.R", local = M <- new.env())
```

```{r, cache = TRUE}
START_DATE <- now() - ddays(10)
END_DATE <- now()

users <-
  M$slackr_fixed_users() %>%
  as_tibble() %>%
  select(id, user_name = name)

channels <- slackr_channels()

messages <-
  channels %>%
  select(-topic, -purpose) %>%
  mutate(
    history = map(name, ~ {
      # slack api rate limits at 50 / minute for this kind of request
      Sys.sleep(3)
      res <- history_slackr(1000, channel = paste0('#', .x), oldest = as.numeric(START_DATE))
      # slackr returns inconsistent types, so we use only tibbles... :/
      if (is_empty(res)) return(tibble())
      select(res, user, text, ts)
      })
    ) %>%
  as_tibble() %>%
  unnest(history) %>%
  mutate(ts = as_datetime(as.numeric(ts)))
```

## Frequency of joining channels

The plot below shows how many users joined each CfP slack channel after `r START_DATE`.
Note we had just under 15 users join last week (and get put in the 3 default channels). Overall, a few things stood out to me..

1. "Project research" and "Home Repair for Seniors" are 1st and 3rd on the [active projects page](https://codeforphilly.org/projects), which likely influenced people joining (also, it counted me joining both..).
2. Marieke does an incredible job directly inviting people to the Cypher Philly channel.
3. Other projects that people joined are on the [active project spreadsheet](https://docs.google.com/spreadsheets/d/1m2I83cjiui5Q6vS6pifZHQKnzrMhjWsgWjqsE3LyKhk/edit#gid=0).

As a side note, I had no idea some of the non-project channels, like "codeforphilly101" or "hacknight" existed...


```{r}
messages %>%
  filter(str_detect(text, "> has joined")) %>%
  count(name_normalized) %>%
  mutate(channel = fct_reorder(name_normalized, n)) %>%
  ggplot(aes(channel, n)) +
  geom_col() +
  coord_flip() +
  labs(
    title = "Users joining each slack channel",
    y = "N users joined"
    )
```

## Relationship between users and channels

The graph below shows each user that messaged a channel in the last week (blue nodes),
and their connection (via messages) to the different channels (orange nodes).
The thickness of lines indicates how many messages they sent in the past week.

```{r}
library(visNetwork)
library(networkD3)

edges <-
  messages %>%
  filter(!str_detect(text, "> has left the channel")) %>%
  select(name, user) %>%
  left_join(users, c("user" = "id")) %>%
  mutate(user = ifelse(is.na(user), "BOT", user)) %>%
  rename(from = user, to = name) %>%
  group_by(from, to) %>%
  summarize(value = n())

nodes <- 
  tibble(id = unique(c(edges$from, edges$to))) %>%
  mutate(
    color = ifelse(id %in% edges$from, "blue", "orange"),
    title = id
    ) %>%
  left_join(users, "id") %>%
  mutate(title = ifelse(is.na(user_name), title, user_name))

visNetwork(nodes, edges) %>%
  visIgraphLayout(layout = "layout.fruchterman.reingold")


```

